{% extends "base.html" %}

{% block title %}Admin Dashboard - Attendance Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-cog"></i> Admin Dashboard</h2>
        <p class="text-muted">Manage attendance settings and view reports</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-plus"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMeetingModal">
                        <i class="fas fa-plus"></i> Add Meeting
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addOutreachModal">
                        <i class="fas fa-handshake"></i> Add Outreach
                    </button>
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#createPeriodModal">
                        <i class="fas fa-calendar-alt"></i> Create Period
                    </button>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#excuseModal">
                        <i class="fas fa-user-times"></i> Excuse User
                    </button>
                    <a href="{{ url_for('admin_users') }}" class="btn btn-info">
                        <i class="fas fa-users"></i> Manage Users
                    </a>
                    <a href="{{ url_for('admin_excuse_requests') }}" class="btn btn-warning">
                        <i class="fas fa-clipboard-list"></i> Excuse Requests
                    </a>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#importCsvModal">
                        <i class="fas fa-file-import"></i> Import CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ periods|length }}</h4>
                        <p class="text-muted">Reporting Periods</p>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ periods|selectattr('start_date', 'le', now)|selectattr('end_date', 'ge', now)|list|length if periods else 0 }}</h4>
                        <p class="text-muted">Active Periods</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Reporting Periods</h5>
            </div>
            <div class="card-body">
                {% if periods %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for period in periods %}
                            <tr>
                                <td>{{ period.name }}</td>
                                <td>{{ period.start_date.strftime('%B %d, %Y') }}</td>
                                <td>{{ period.end_date.strftime('%B %d, %Y') }}</td>
                                <td>
                                    {% if period.start_date <= now and period.end_date >= now %}
                                        <span class="badge bg-success">Active</span>
                                    {% elif period.start_date > now %}
                                        <span class="badge bg-warning">Upcoming</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Completed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('attendance_report', period_id=period.id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-chart-line"></i> View Report
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePeriod({{ period.id }}, '{{ period.name }}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No reporting periods created yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Meeting Modal -->
<div class="modal fade" id="addMeetingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Regular Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMeetingForm">
                    <div class="mb-3">
                        <label for="meetingDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="meetingDate" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startTime" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="startTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endTime" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="endTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="meetingDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="meetingDescription" placeholder="Meeting description">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addMeeting()">Add Meeting</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Outreach Modal -->
<div class="modal fade" id="addOutreachModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Outreach Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addOutreachForm">
                    <div class="mb-3">
                        <label for="outreachDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="outreachDate" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="outreachStartTime" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="outreachStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="outreachEndTime" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="outreachEndTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="outreachDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="outreachDescription" placeholder="Outreach event description">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="addOutreach()">Add Outreach</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Period Modal -->
<div class="modal fade" id="createPeriodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Reporting Period</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPeriodForm">
                    <div class="mb-3">
                        <label for="periodName" class="form-label">Period Name</label>
                        <input type="text" class="form-control" id="periodName" placeholder="e.g., Fall Season 2024" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="periodStartDate" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="periodStartDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="periodEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="periodEndDate" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createPeriod()">Create Period</button>
            </div>
        </div>
    </div>
</div>

<!-- Excuse User Modal -->
<div class="modal fade" id="excuseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Excuse User from Meeting</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="excuseForm">
                    <div class="mb-3">
                        <label for="excuseUserId" class="form-label">User ID</label>
                        <input type="number" class="form-control" id="excuseUserId" placeholder="User ID" required>
                    </div>
                    <div class="mb-3">
                        <label for="excuseMeetingId" class="form-label">Meeting ID</label>
                        <input type="number" class="form-control" id="excuseMeetingId" placeholder="Meeting ID" required>
                    </div>
                    <div class="mb-3">
                        <label for="excuseReason" class="form-label">Reason</label>
                        <textarea class="form-control" id="excuseReason" rows="3" placeholder="Reason for excuse" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="excuseUser()">Excuse User</button>
            </div>
        </div>
    </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importCsvModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import CSV Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="importCsvForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="csvFile" class="form-label">CSV File</label>
                        <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                        <div class="form-text">
                            <strong>Expected format:</strong><br>
                            • First row: usernames (after first two columns)<br>
                            • First column: dates (MM/DD/YYYY or YYYY-MM-DD)<br>
                            • Second column: meeting length in hours<br>
                            • Rest: hours attended by each user<br>
                            • Weekday meetings start at 15:30, weekend at 10:00
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dataType" class="form-label">Data Type</label>
                        <select class="form-select" id="dataType" required>
                            <option value="">Select data type</option>
                            <option value="attendance">Attendance Data</option>
                            <option value="outreach">Outreach Data</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Reporting Period</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="periodAction" id="newPeriod" value="new" checked>
                            <label class="form-check-label" for="newPeriod">
                                Create New Period
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="periodAction" id="existingPeriod" value="existing">
                            <label class="form-check-label" for="existingPeriod">
                                Use Existing Period
                            </label>
                        </div>
                    </div>
                    
                    <!-- New Period Fields -->
                    <div id="newPeriodFields">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="periodName" class="form-label">Period Name</label>
                                    <input type="text" class="form-control" id="periodName" placeholder="e.g., Fall Season 2024">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="periodStartDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="periodStartDate">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="periodEndDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="periodEndDate">
                        </div>
                    </div>
                    
                    <!-- Existing Period Fields -->
                    <div id="existingPeriodFields" style="display: none;">
                        <div class="mb-3">
                            <label for="existingPeriodId" class="form-label">Select Period</label>
                            <select class="form-select" id="existingPeriodId">
                                <option value="">Select a period</option>
                                {% for period in periods %}
                                <option value="{{ period.id }}">{{ period.name }} ({{ period.start_date.strftime('%Y-%m-%d') }} to {{ period.end_date.strftime('%Y-%m-%d') }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="importCsv()">Import CSV</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addMeeting() {
    const data = {
        date: document.getElementById('meetingDate').value,
        start_time: document.getElementById('startTime').value,
        end_time: document.getElementById('endTime').value,
        description: document.getElementById('meetingDescription').value
    };
    
    if (!data.date || !data.start_time || !data.end_time) {
        alert('Please fill in all required fields.');
        return;
    }
    
    fetch('/admin/add_meeting', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            // Clear form
            document.getElementById('addMeetingForm').reset();
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addMeetingModal'));
            modal.hide();
            // Reload page to show new meeting
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding meeting. Please try again.');
    });
}

function addOutreach() {
    const data = {
        date: document.getElementById('outreachDate').value,
        start_time: document.getElementById('outreachStartTime').value,
        end_time: document.getElementById('outreachEndTime').value,
        description: document.getElementById('outreachDescription').value
    };
    
    if (!data.date || !data.start_time || !data.end_time) {
        alert('Please fill in all required fields.');
        return;
    }
    
    fetch('/admin/add_outreach', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            // Clear form
            document.getElementById('addOutreachForm').reset();
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addOutreachModal'));
            modal.hide();
            // Reload page to show new outreach event
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding outreach event. Please try again.');
    });
}

function createPeriod() {
    const data = {
        name: document.getElementById('periodName').value.trim(),
        start_date: document.getElementById('periodStartDate').value,
        end_date: document.getElementById('periodEndDate').value
    };
    
    if (!data.name || !data.start_date || !data.end_date) {
        alert('Please fill in all required fields.');
        return;
    }
    
    fetch('/admin/create_period', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            // Clear form
            document.getElementById('createPeriodForm').reset();
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('createPeriodModal'));
            modal.hide();
            // Reload page to show new period
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating period. Please try again.');
    });
}

function excuseUser() {
    const data = {
        user_id: document.getElementById('excuseUserId').value,
        meeting_id: document.getElementById('excuseMeetingId').value,
        reason: document.getElementById('excuseReason').value.trim()
    };
    
    if (!data.user_id || !data.meeting_id || !data.reason) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // For now, show Slack command since this is complex to implement in web interface
    alert('Use the Slack command: /excuse ' + data.user_id + ' ' + data.meeting_id + ' ' + data.reason);
    
    // Clear form
    document.getElementById('excuseForm').reset();
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('excuseModal'));
    modal.hide();
}

function deletePeriod(periodId, periodName) {
    if (confirm(`Are you sure you want to delete the reporting period "${periodName}"? This action cannot be undone.`)) {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/period/${periodId}/delete`;
        
        // Add CSRF token if needed (you might need to add this)
        // const csrfToken = document.querySelector('meta[name="csrf-token"]');
        // if (csrfToken) {
        //     const csrfInput = document.createElement('input');
        //     csrfInput.type = 'hidden';
        //     csrfInput.name = 'csrf_token';
        //     csrfInput.value = csrfToken.getAttribute('content');
        //     form.appendChild(csrfInput);
        // }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// CSV Import functionality
document.addEventListener('DOMContentLoaded', function() {
    // Handle period action radio buttons
    const newPeriodRadio = document.getElementById('newPeriod');
    const existingPeriodRadio = document.getElementById('existingPeriod');
    const newPeriodFields = document.getElementById('newPeriodFields');
    const existingPeriodFields = document.getElementById('existingPeriodFields');
    
    newPeriodRadio.addEventListener('change', function() {
        if (this.checked) {
            newPeriodFields.style.display = 'block';
            existingPeriodFields.style.display = 'none';
        }
    });
    
    existingPeriodRadio.addEventListener('change', function() {
        if (this.checked) {
            newPeriodFields.style.display = 'none';
            existingPeriodFields.style.display = 'block';
        }
    });
});

function importCsv() {
    const csvFile = document.getElementById('csvFile').files[0];
    const dataType = document.getElementById('dataType').value;
    const periodAction = document.querySelector('input[name="periodAction"]:checked').value;
    
    if (!csvFile || !dataType || !periodAction) {
        alert('Please fill in all required fields.');
        return;
    }
    
    // Validate new period fields if creating new period
    if (periodAction === 'new') {
        const periodName = document.getElementById('periodName').value.trim();
        const periodStartDate = document.getElementById('periodStartDate').value;
        const periodEndDate = document.getElementById('periodEndDate').value;
        
        if (!periodName || !periodStartDate || !periodEndDate) {
            alert('Please fill in all period fields for new period.');
            return;
        }
    } else {
        const existingPeriodId = document.getElementById('existingPeriodId').value;
        if (!existingPeriodId) {
            alert('Please select an existing period.');
            return;
        }
    }
    
    // Create FormData for file upload
    const formData = new FormData();
    formData.append('csv_file', csvFile);
    formData.append('data_type', dataType);
    formData.append('period_action', periodAction);
    
    if (periodAction === 'new') {
        formData.append('period_name', document.getElementById('periodName').value.trim());
        formData.append('period_start_date', document.getElementById('periodStartDate').value);
        formData.append('period_end_date', document.getElementById('periodEndDate').value);
    } else {
        formData.append('period_id', document.getElementById('existingPeriodId').value);
    }
    
    // Show loading state
    const importButton = document.querySelector('#importCsvModal .btn-primary');
    const originalText = importButton.textContent;
    importButton.textContent = 'Importing...';
    importButton.disabled = true;
    
    fetch('/admin/import_csv', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            
            // Show detailed results
            if (result.details && result.details.length > 0) {
                const detailsText = result.details.slice(0, 10).join('\n'); // Show first 10 details
                const moreDetails = result.details.length > 10 ? `\n... and ${result.details.length - 10} more entries` : '';
                console.log('Import details:', result.details);
                if (result.details.length > 0) {
                    alert(`Import completed!\n\nFirst few details:\n${detailsText}${moreDetails}`);
                }
            }
            
            // Clear form
            document.getElementById('importCsvForm').reset();
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('importCsvModal'));
            modal.hide();
            // Reload page to show new data
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error importing CSV. Please try again.');
    })
    .finally(() => {
        // Reset button state
        importButton.textContent = originalText;
        importButton.disabled = false;
    });
}
</script>
{% endblock %}
